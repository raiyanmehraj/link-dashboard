# Link Dashboard - AI Coding Agent Instructions

## Project Overview
Link Dashboard is a web-based curation tool for organizing, searching, and summarizing educational/personal development links. It's a fully client-side + serverless architecture with three main components:

- **Frontend**: Vanilla JavaScript SPA with category filtering, tagging, search, and edit capabilities
- **Storage**: Browser localStorage persists all links locally (key: `'study-links'`)
- **API**: Serverless function (`/api/summarize`) that fetches URLs, extracts content via Mozilla Readability, and generates summaries using OpenRouter's gpt-oss-120b

## Architecture & Data Flow

### Core State Object (`app.js`)
```javascript
const state = {
  links: [],              // Array of link objects with id, title, url, category, tags, etc.
  searchQuery: '',        // Current search text
  activeCategory: 'All',  // Current sidebar filter
  activeTag: null,        // Optional tag filter (single tag at a time)
  isModalOpen: false,     // Add/edit modal visibility
  isSidebarOpen: true,    // Desktop sidebar collapsed state
  editingId: null,        // If non-null, modal is in edit mode
  subEntries: [],         // Temporary state for multiple-URL mode inputs
  urlMode: 'single'       // 'single' (one URL) or 'multiple' (sub-entries array)
}
```

### Link Object Structure
```javascript
{
  id: string,                      // crypto.randomUUID()
  title: string,                   // Required
  url: string,                     // Required for 'single' mode, ignored in 'multiple'
  category: string,                // One of CATEGORIES: 'Study Materials', 'Development', 'Tools and other'
  contributor: string,             // Optional, name/email of who added it
  tags: string[],                  // Flexible tags for filtering (no predefined list)
  createdAt: number,               // Timestamp (milliseconds)
  subEntries?: [{id, title, url, summary?}],  // Only for 'multiple' URL mode
  summary?: string                 // Generated by /api/summarize if populated
}
```

### Render Pipeline
All UI updates cascade from `renderLinks()` → `createLinkCard()` + `renderSidebar()`. This means:
- **Do NOT directly manipulate DOM**; always update `state` and call appropriate render function
- Search, category filters, and tag filters all trigger `getFilteredLinks()` which respects all three conditions
- Link counts in sidebar update via `renderSidebar()`

## Key Conventions & Patterns

### 1. URL Handling
- User input URLs are **normalized** to include `https://` if missing (line 333-335)
- Never directly use `link.url`; always access via `link.url` after normalization
- Sub-entries in 'multiple' mode must also be normalized when saved

### 2. Tag System
- Tags are **manually typed** by users (not predefined); added via Enter key in modal
- Only **one tag filter** can be active at a time (stored in `state.activeTag`)
- Clicking a tag in the link card filters to that tag; clicking again clears filter
- Backspace removes the last tag from the input

### 3. Edit vs. Add Mode
- Modal opens with `openModal()`; if `state.editingId` is set, it's edit mode
- Edit mode pre-populates all fields including `dateInput` (formatted as ISO datetime)
- URL mode is inferred from existing subEntries: if `link.subEntries.length > 0`, switch to 'multiple' mode
- New links always start in 'single' mode and default category is 'Study Materials'

### 4. Sub-Entries (Multiple URLs)
- Unique to a single link; each sub-entry has `{id, title, url, summary?}`
- Sub-entries can be summarized independently
- `renderSubEntryInputs()` dynamically binds event listeners to `.sub-title`, `.sub-url`, and `.remove-sub` buttons
- Validation: 'multiple' mode requires at least one sub-entry with content

### 5. Summarization Flow
- Both main links and sub-entries support summaries via `/api/summarize` endpoint
- Summary request: `POST /api/summarize` with `{url}`
- Response: `{title, excerpt, summary, cached?: boolean}`
- If summary exists, user is prompted before regenerating
- Summaries are stored in `link.summary` or `subEntry.summary`; saved to localStorage immediately

### 6. Keyboard Shortcuts
- `Ctrl+K` (or `Cmd+K`): Focus search input
- `Ctrl+N` (or `Cmd+N`): Open add-link modal
- `Escape`: Close modal and clear active tag filter
- `Enter` in tags input: Add tag
- `Backspace` in empty tags input: Remove last tag

### 7. Responsive Layout
- **Desktop**: Sidebar always visible (can be toggled collapsed), main content adjusts width
- **Mobile**: Sidebar hidden; hamburger menu toggles overlay sidebar
- `isMobileMenuOpen` state controls `.mobile-sidebar` visibility

## Serverless API (`api/summarize.js`)

### Environment
- Requires `OPENROUTER_API_KEY` env var (check at runtime)
- Uses Mozilla Readability + jsdom to extract main content from HTML

### Logic
1. Check in-memory cache (`{url}` → cached summary)
2. Fetch HTML with retries and user-agent
3. Extract content via Readability; fallback to meta description
4. Call OpenRouter `gpt-oss-120b` with system prompt for concise summaries (headline + sentence + 3 bullets)
5. Cache result for 24 hours

### Notes
- **In-memory cache works only during warm instances**; for production, migrate to Redis/DB
- Error handling: Returns 400/500 with `{error: string}` on client side; display via alert()
- No rate limiting currently implemented

## Developer Workflows

### Local Development
1. Open `index.html` directly in browser (no build required)
2. Data persists in localStorage automatically
3. To test API summarization locally, you need the Vercel CLI:
   ```bash
   npm install -g vercel
   cd api && npm install
   vercel dev  # Runs on localhost:3000, function at /api/summarize
   ```
4. Set `OPENROUTER_API_KEY` in `.env.local` in api folder

### Debugging Tips
- **Link not saving?** Check `saveLinksToStorage()` is called after state mutation
- **Render not updating?** Ensure you call the correct render function (not just one)
- **Modal state stuck?** Check that `closeModal()` sets `state.isModalOpen = false`
- **Tags not showing?** Verify `renderTags()` inserts tags before `elements.tagsInput`

## Common Tasks & Patterns

### Adding a New Filter Type
1. Add property to `state` (e.g., `activeStatus`)
2. Update `getFilteredLinks()` to include new condition
3. Update sidebar or modal UI to populate filter
4. Call `renderLinks()` when filter changes

### Modifying Link Card Layout
1. Edit the template in `createLinkCard()` function
2. Any new event listeners must bind in the same function
3. Use `escapeHTML()` for any user-generated content
4. Test with both 'single' and 'multiple' URL modes

### Adding New Categories
1. Update `CATEGORIES` array at top of app.js
2. Update `renderSidebar()` icons/labels if needed
3. Category counts update automatically via filter logic

### Summarization Enhancements
1. Frontend: Modify `handleSummarize()` or `handleSummarizeSubEntry()` for UI changes
2. Backend: Edit `callOpenRouterSummarize()` to change prompt, model, or temperature
3. Caching: Replace `cache.set()/get()` logic with external cache library

## Testing Checklist
- [ ] Links persist after page refresh
- [ ] Search works on title, URL, contributor, and tags
- [ ] Category filter narrows links correctly
- [ ] Tag filter (click a tag) works and shows count
- [ ] Escape clears tag filter
- [ ] Edit link pre-populates all fields including date
- [ ] URL normalization adds https:// when missing
- [ ] Sub-entry mode toggles URL visibility correctly
- [ ] Delete removes link immediately
- [ ] Summarize button disables and shows loading state
- [ ] Mobile sidebar toggles correctly

## File Organization
```
/                     # Root
  ├─ index.html       # Single HTML entry point
  ├─ app.js           # 860 lines: state, rendering, event handling, summarization
  ├─ styles.css       # Responsive design, timeline, cards, modals
  ├─ api/
  │  ├─ summarize.js  # Serverless function
  │  └─ package.json  # @mozilla/readability, jsdom
  └─ .github/
     └─ copilot-instructions.md (this file)
```
